<!-- 
    Bill Splitter App (Smart Share Edition)
    Developed by Babu Mani (@ChartWizMani)
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Splitter - By Babu Mani</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Framework -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Styles -->
    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f8fafc;
            user-select: none; 
        }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        .select-wrapper { position: relative; }
        .select-wrapper::after {
            content: 'â–¼'; font-size: 0.7rem; position: absolute; right: 8px; top: 50%;
            transform: translateY(-50%); pointer-events: none; color: #64748b;
        }
    </style>

    <!-- Security: Disable Right Click -->
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false; 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false; 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false; 
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; 
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Developed by Babu Mani (@ChartWizMani)
        const { useState, useEffect } = React;

        // --- Icons ---
        const IconCalculator = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>;
        const IconRotateCcw = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;
        const IconTrash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const IconCopy = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const IconShare = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>;

        const DEFAULT_MEMBERS = [
            { id: 1, unit: '101', name: 'B. Shivakumar', type: 'house', count: 1 },
            { id: 2, unit: '102', name: 'Ajay Kumar', type: 'family', count: 7 },
            { id: 3, unit: '103', name: 'Afjal Hussain', type: 'family', count: 5 },
            { id: 4, unit: 'G-1', name: 'Yasmin', type: 'family', count: 4 },
            { id: 5, unit: 'G-2', name: 'Kedar Dena', type: 'family', count: 4 },
            { id: 6, unit: 'S-1', name: 'Shop 1', type: 'shop', count: 1 },
        ];

        function App() {
            const [waterBill, setWaterBill] = useState('');
            const [motorBill, setMotorBill] = useState('');
            const [tankerBill, setTankerBill] = useState('');
            
            const [members, setMembers] = useState(DEFAULT_MEMBERS);
            const [houseRate, setHouseRate] = useState(500);
            const [shopRate, setShopRate] = useState(200);
            
            const [result, setResult] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');

            // --- SMART LOAD: Check for URL data first ---
            useEffect(() => {
                const checkUrlForConfig = () => {
                    if (window.location.hash.length > 1) {
                        try {
                            const compressedData = window.location.hash.substring(1);
                            const decoded = JSON.parse(atob(compressedData));
                            
                            if (confirm("Found a new configuration in the link! Do you want to load it? (This will overwrite current data)")) {
                                if(decoded.members) setMembers(decoded.members);
                                if(decoded.houseRate) setHouseRate(decoded.houseRate);
                                if(decoded.shopRate) setShopRate(decoded.shopRate);
                                
                                // Clean URL after loading
                                window.history.pushState("", document.title, window.location.pathname + window.location.search);
                                alert("Data loaded successfully!");
                            }
                        } catch (e) {
                            console.error("Invalid link data", e);
                        }
                    } else {
                        // Load local storage if no URL data
                        const savedData = localStorage.getItem('billSplitterData_v5');
                        if (savedData) {
                            const parsed = JSON.parse(savedData);
                            if(parsed.members) setMembers(parsed.members);
                            if(parsed.houseRate !== undefined) setHouseRate(parsed.houseRate);
                            if(parsed.shopRate !== undefined) setShopRate(parsed.shopRate);
                        }
                    }
                };
                
                checkUrlForConfig();
            }, []);

            useEffect(() => {
                const dataToSave = { members, houseRate, shopRate };
                localStorage.setItem('billSplitterData_v5', JSON.stringify(dataToSave));
            }, [members, houseRate, shopRate]);

            // --- Handlers ---
            const handleAddMember = () => setMembers([...members, { id: Date.now(), unit: '', name: '', type: 'family', count: 1 }]);
            const handleRemoveMember = (id) => setMembers(members.filter(m => m.id !== id));
            const handleUpdateMember = (id, field, value) => setMembers(members.map(m => m.id === id ? { ...m, [field]: value } : m));

            // --- SHARE CONFIGURATION ---
            const generateShareLink = () => {
                const data = { members, houseRate, shopRate };
                const compressed = btoa(JSON.stringify(data)); // Simple encoding
                const url = window.location.href.split('#')[0] + '#' + compressed;
                
                const textArea = document.createElement("textarea");
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('Setup Link Copied! \n\nSend this link to your family member. When they open it, they will get this exact list of names and rates.');
                } catch (err) {
                    console.error('Failed to copy', err);
                }
                document.body.removeChild(textArea);
            };

            const calculate = () => {
                const water = parseFloat(waterBill) || 0;
                const motor = parseFloat(motorBill) || 0;
                const tanker = parseFloat(tankerBill) || 0;
                const currentHouseRate = parseFloat(houseRate) || 0;
                const currentShopRate = parseFloat(shopRate) || 0;
                
                const totalBill = water + motor + tanker;
                let fixedCollection = 0;
                let totalVariableMembers = 0;

                members.forEach(m => {
                    if (m.type === 'house') fixedCollection += currentHouseRate;
                    else if (m.type === 'shop') fixedCollection += currentShopRate;
                    else if (m.type === 'vacant') { }
                    else totalVariableMembers += parseInt(m.count) || 0;
                });

                let finalHouseRate = currentHouseRate;
                let finalShopRate = currentShopRate;
                let remainingBill = 0;
                let perPersonCost = 0;
                let totalActualCollection = 0;

                if (totalBill <= fixedCollection) {
                    const scale = fixedCollection > 0 ? (totalBill / fixedCollection) : 0;
                    finalHouseRate = currentHouseRate * scale;
                    finalShopRate = currentShopRate * scale;
                    remainingBill = 0;
                    perPersonCost = 0;
                    totalActualCollection = totalBill;
                } else {
                    remainingBill = totalBill - fixedCollection;
                    perPersonCost = totalVariableMembers > 0 ? (remainingBill / totalVariableMembers) : 0;
                    totalActualCollection = fixedCollection;
                }

                const breakdown = members.map(m => {
                    let amount = 0;
                    let detail = '';
                    if (m.type === 'house') { amount = finalHouseRate; detail = 'Fixed House'; }
                    else if (m.type === 'shop') { amount = finalShopRate; detail = 'Fixed Shop'; }
                    else if (m.type === 'vacant') { amount = 0; detail = 'Vacant'; }
                    else { amount = (parseInt(m.count) || 0) * perPersonCost; detail = `${m.count} members Ã— â‚¹${perPersonCost.toFixed(2)}`; }
                    return { ...m, amount, detail };
                });

                setResult({ totalBill, perPersonCost, breakdown, water, motor, tanker, remainingBill, totalActualCollection });
            };

            const copyToClipboard = () => {
                if (!result) return;
                const date = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
                let text = `*Bill Details - ${date}*\n`;
                text += `Developed by Babu Mani (@ChartWizMani)\n\n`;
                if(result.water > 0) text += `ðŸ’§ Water Bill: â‚¹${result.water}\n`;
                if(result.motor > 0) text += `âš¡ Motor Bill: â‚¹${result.motor}\n`;
                if(result.tanker > 0) text += `ðŸš› Outside Water: â‚¹${result.tanker}\n`;
                text += `*Total Bill: â‚¹${result.totalBill.toLocaleString()}*\n`;
                if (result.perPersonCost > 0) text += `(Family Rate: â‚¹${result.perPersonCost.toFixed(2)} / member)\n`;
                text += `\n*Breakdown:*\n`;
                result.breakdown.forEach(item => {
                    const nameDisplay = item.unit ? (item.name ? `${item.unit} (${item.name})` : item.unit) : item.name;
                    text += `${nameDisplay}: â‚¹${Math.round(item.amount).toLocaleString()} (${item.detail})\n`;
                });
                text += `\nTotal: â‚¹${Math.round(result.breakdown.reduce((a, b) => a + b.amount, 0)).toLocaleString()}`;

                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try { document.execCommand('copy'); alert('Details copied!'); } catch (err) {}
                document.body.removeChild(textArea);
            };

            const resetToDefault = () => {
                if(confirm("Reset everything to default?")) {
                    setMembers(DEFAULT_MEMBERS); setWaterBill(''); setMotorBill(''); setTankerBill(''); setResult(null); setHouseRate(500); setShopRate(200);
                }
            };

            return (
                <div className="min-h-screen font-sans p-3 md:p-6 max-w-2xl mx-auto text-slate-900">
                    <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                        <div className="bg-blue-600 p-6 text-white flex justify-between items-center">
                            <div><h1 className="text-2xl font-bold">Bill Splitter</h1><p className="text-blue-100 opacity-90 text-sm">Smart Share Edition</p></div>
                            <button onClick={resetToDefault} className="p-2 bg-blue-500 rounded-full hover:bg-blue-400 transition"><IconRotateCcw /></button>
                        </div>

                        <div className="p-5 space-y-6">
                            <section className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h2 className="text-md font-bold text-slate-700 mb-3">1. Bill Amounts</h2>
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Water Bill</label><input type="number" value={waterBill} onChange={(e) => setWaterBill(e.target.value)} className="w-full text-xl p-2 rounded-lg border border-slate-300 focus:border-blue-500 outline-none bg-white" placeholder="0" /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Motor Bill</label><input type="number" value={motorBill} onChange={(e) => setMotorBill(e.target.value)} className="w-full text-xl p-2 rounded-lg border border-slate-300 focus:border-blue-500 outline-none bg-white" placeholder="0" /></div>
                                </div>
                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Water Supply / Tanker</label><input type="number" value={tankerBill} onChange={(e) => setTankerBill(e.target.value)} className="w-full text-xl p-2 rounded-lg border border-slate-300 focus:border-blue-500 outline-none bg-white" placeholder="0" /></div>
                            </section>

                            <section>
                                <div className="flex justify-between items-center mb-3">
                                    <h2 className="text-md font-bold text-slate-700">2. Register</h2>
                                    <div className="flex gap-2">
                                        <button onClick={generateShareLink} className="flex items-center gap-1 text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded hover:bg-green-100 border border-green-200">
                                            <IconShare /> ðŸ”— Share Setup
                                        </button>
                                        <button onClick={() => setShowSettings(!showSettings)} className="flex items-center gap-1 text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded hover:bg-blue-100 border border-blue-200">
                                            <IconSettings /> {showSettings ? 'Hide Rates' : 'Edit Rates'}
                                        </button>
                                    </div>
                                </div>

                                {showSettings && (
                                    <div className="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200 grid grid-cols-2 gap-4 animate-in fade-in slide-in-from-top-2">
                                        <div><label className="text-xs font-bold text-yellow-800 block mb-1">House Fixed</label><div className="flex items-center bg-white px-1 rounded border border-yellow-300"><span className="text-xs font-bold text-yellow-600 px-1">â‚¹</span><input type="number" value={houseRate} onChange={(e) => setHouseRate(e.target.value)} className="w-full p-1 outline-none text-sm" /></div></div>
                                        <div><label className="text-xs font-bold text-yellow-800 block mb-1">Shop Fixed</label><div className="flex items-center bg-white px-1 rounded border border-yellow-300"><span className="text-xs font-bold text-yellow-600 px-1">â‚¹</span><input type="number" value={shopRate} onChange={(e) => setShopRate(e.target.value)} className="w-full p-1 outline-none text-sm" /></div></div>
                                    </div>
                                )}

                                <div className="space-y-3">
                                    {members.map((member) => (
                                        <div key={member.id} className="flex flex-col gap-2 p-3 bg-white rounded-lg border border-slate-200 shadow-sm">
                                            <div className="flex gap-2">
                                                <div className="w-1/3"><input type="text" value={member.unit || ''} onChange={(e) => handleUpdateMember(member.id, 'unit', e.target.value)} className="w-full font-bold text-md p-1 outline-none bg-slate-50 rounded border border-slate-200 focus:border-blue-200 text-center uppercase" placeholder="Unit" /></div>
                                                <div className="flex-grow flex justify-between items-center gap-2"><input type="text" value={member.name} onChange={(e) => handleUpdateMember(member.id, 'name', e.target.value)} className="flex-grow font-semibold text-md p-1 outline-none bg-transparent border-b border-transparent focus:border-blue-200 placeholder:font-normal" placeholder="Tenant Name" /><button onClick={() => handleRemoveMember(member.id)} className="p-1 text-slate-300 hover:text-red-500"><IconTrash2 /></button></div>
                                            </div>
                                            <div className="flex items-center gap-3 bg-slate-50 p-2 rounded-md">
                                                <div className="flex-grow select-wrapper">
                                                    <select value={member.type} onChange={(e) => handleUpdateMember(member.id, 'type', e.target.value)} className="w-full bg-transparent text-sm font-medium text-slate-600 outline-none appearance-none">
                                                        <option value="family">Family (Count)</option>
                                                        <option value="house">Fixed House (â‚¹{houseRate})</option>
                                                        <option value="shop">Fixed Shop (â‚¹{shopRate})</option>
                                                        <option value="vacant">Vacant (â‚¹0)</option>
                                                    </select>
                                                </div>
                                                {member.type === 'family' ? (
                                                    <div className="flex items-center gap-1 bg-white rounded px-2 border border-slate-200"><span className="text-[10px] text-slate-400 uppercase font-bold">Members</span><input type="number" value={member.count} onChange={(e) => handleUpdateMember(member.id, 'count', e.target.value)} className="w-10 text-center p-1 outline-none font-bold" /></div>
                                                ) : member.type === 'vacant' ? (
                                                     <div className="flex items-center bg-slate-200 rounded px-3 py-1 border border-slate-300 opacity-70"><span className="text-xs font-bold text-slate-600">â‚¹0</span></div>
                                                ) : (
                                                    <div className="flex items-center bg-slate-200 rounded px-3 py-1 border border-slate-300 opacity-70"><span className="text-xs font-bold text-slate-600">â‚¹{member.type === 'house' ? houseRate : shopRate}</span></div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={handleAddMember} className="mt-4 flex items-center gap-2 text-blue-600 font-bold text-sm px-2 py-2 w-full justify-center border border-dashed border-blue-200 rounded-lg hover:bg-blue-50"><IconPlus /> Add New Unit</button>
                            </section>
                            <button onClick={calculate} className="w-full py-3 bg-blue-600 text-white text-lg font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 hover:bg-blue-700 active:scale-95 transition"><IconCalculator /> CALCULATE SHARES</button>
                            {result && (
                                <div className="animate-bounce-in">
                                    <div className="bg-slate-800 text-white p-5 rounded-t-2xl mt-4">
                                        <div className="flex justify-between items-end"><span className="text-slate-400 font-medium text-sm">Total Collection</span><span className="text-3xl font-bold text-green-400">â‚¹{result.totalBill.toLocaleString()}</span></div>
                                        <div className="mt-3 pt-3 border-t border-slate-600 text-xs text-slate-400 space-y-1"><div className="flex justify-between"><span>Total Fixed Collected:</span> <span>-â‚¹{result.totalActualCollection.toFixed(0)}</span></div><div className="flex justify-between"><span>Remaining for Families:</span> <span>â‚¹{result.remainingBill.toFixed(2)}</span></div><div className="flex justify-between font-mono text-green-300 pt-1"><span>Family Rate:</span> <span>â‚¹{result.perPersonCost.toFixed(2)} / head</span></div></div>
                                    </div>
                                    <div className="border-x border-b border-slate-200 rounded-b-2xl bg-white p-4 shadow-lg">
                                        <div className="divide-y divide-slate-100">{result.breakdown.map((item) => (<div key={item.id} className="py-2 flex justify-between items-center group hover:bg-slate-50"><div><div className="font-bold text-slate-700 text-sm">{item.unit && <span className="inline-block bg-slate-100 px-1 rounded mr-2 text-xs border border-slate-200 text-slate-500">{item.unit}</span>}{item.name || 'Unknown'}</div><div className="text-xs text-slate-400">{item.detail}</div></div><div className="font-bold text-lg">â‚¹{Math.round(item.amount).toLocaleString()}</div></div>))}</div>
                                        <button onClick={copyToClipboard} className="w-full mt-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-md"><IconCopy /> Share on WhatsApp</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="text-center mt-8 opacity-60 hover:opacity-100 transition-opacity"><p className="text-sm font-medium text-slate-500">Developed by Babu Mani (@ChartWizMani)</p></div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
