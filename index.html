<!-- 
    Bill Splitter App v15.0 (Debug Logs + Sync Lock Fix)
    Developed by Babu Mani (@ChartWizMani)
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Splitter - Cloud</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Framework -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE (Stable Version 8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Styles -->
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f8fafc; user-select: none; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .select-wrapper { position: relative; }
        .select-wrapper::after { content: '▼'; font-size: 0.7rem; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #64748b; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        .tab-inactive { color: #64748b; }
        .history-card { transition: all 0.2s; }
        .history-expanded { border: 1px solid #3b82f6; background-color: #eff6ff; }
        .status-btn { transition: all 0.2s; }
        .status-btn:active { transform: scale(0.9); }
        .modal-overlay { background-color: rgba(0,0,0,0.5); position: fixed; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; }
        .debug-console { font-family: monospace; font-size: 10px; color: #0f0; background: #000; padding: 10px; max-height: 150px; overflow-y: auto; margin-top: 20px; border-radius: 8px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Icons = {
            Calc: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Reset: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
            ChevronUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"/></svg>,
            Cloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M19 19V5a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v14"/><path d="M12 10v4"/><path d="M12 2v3"/></svg>,
            CloudOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="2" y1="2" x2="22" y2="22"/><path d="M5.034 5.034A2 2 0 0 0 5 6v11a2 2 0 0 0 2 2h12a2 2 0 0 0 1.926-.854"/><path d="M19 11V6a2 2 0 0 0-2-2H9.83"/></svg>,
            Chart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
            Nuke: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 12v6"/><path d="M12 6h.01"/></svg>
        };

        const DEFAULT_MEMBERS = [
            { id: 1, unit: '101', name: 'B. Shivakumar', type: 'house', count: 1 },
            { id: 2, unit: '102', name: 'Ajay Kumar', type: 'family', count: 7 },
            { id: 3, unit: '103', name: 'Afjal Hussain', type: 'family', count: 5 },
            { id: 4, unit: 'G-1', name: 'Yasmin', type: 'family', count: 4 },
            { id: 5, unit: 'G-2', name: 'Kedar Dena', type: 'family', count: 4 },
            { id: 6, unit: 'S-1', name: 'Shop 1', type: 'shop', count: 1 },
        ];

        function App() {
            // State
            const [activeTab, setActiveTab] = useState('calc'); 
            const [historyView, setHistoryView] = useState('list');
            const [waterBill, setWaterBill] = useState('');
            const [motorBill, setMotorBill] = useState('');
            const [tankerBill, setTankerBill] = useState('');
            const [billMonth, setBillMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM
            const [statsYear, setStatsYear] = useState(new Date().getFullYear().toString()); 
            
            const [members, setMembers] = useState(DEFAULT_MEMBERS);
            const [houseRate, setHouseRate] = useState(500);
            const [shopRate, setShopRate] = useState(200);
            const [result, setResult] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [history, setHistory] = useState([]);
            const [expandedHistory, setExpandedHistory] = useState(null);
            
            const [paymentModal, setPaymentModal] = useState({ show: false, historyIdx: null, memberIdx: null, currentPaid: 0, total: 0, name: '' });
            const [showCloudSetup, setShowCloudSetup] = useState(false);
            const [cloudConfig, setCloudConfig] = useState({ apiKey: '', projectId: '' });
            const [isCloudActive, setIsCloudActive] = useState(false);
            const [syncStatus, setSyncStatus] = useState('');
            const [logs, setLogs] = useState([]); // Debug Logs

            // Ref to prevent race conditions during write
            const ignoreRemoteUpdate = useRef(false);

            const addLog = (msg) => {
                const time = new Date().toLocaleTimeString();
                setLogs(prev => [`[${time}] ${msg}`, ...prev].slice(0, 50));
            };

            // 1. Initial Load
            useEffect(() => {
                const loadSafe = (key) => { try { return JSON.parse(localStorage.getItem(key)) } catch (e) { return null; }};
                const savedData = loadSafe('billSplitterData_v15'); 
                const savedHistory = loadSafe('billSplitterHistory');
                const savedCloud = loadSafe('billSplitterCloudConfig');
                
                if (savedData) {
                    if(savedData.members) setMembers(savedData.members);
                    if(savedData.houseRate) setHouseRate(savedData.houseRate);
                    if(savedData.shopRate) setShopRate(savedData.shopRate);
                    if(savedData.waterBill) setWaterBill(savedData.waterBill);
                    if(savedData.motorBill) setMotorBill(savedData.motorBill);
                    if(savedData.tankerBill) setTankerBill(savedData.tankerBill);
                    if(savedData.billMonth) setBillMonth(savedData.billMonth);
                }
                if (savedHistory) setHistory(savedHistory);
                if (savedCloud) {
                    setCloudConfig(savedCloud);
                    if(savedCloud.apiKey && savedCloud.projectId) initializeFirebase(savedCloud);
                }
            }, []);

            // 2. Data Persistence (Local + Cloud Sync)
            useEffect(() => {
                const dataToSave = { members, houseRate, shopRate, waterBill, motorBill, tankerBill, billMonth };
                localStorage.setItem('billSplitterData_v15', JSON.stringify(dataToSave));
                localStorage.setItem('billSplitterHistory', JSON.stringify(history));

                if (isCloudActive && window.firebaseApp && !ignoreRemoteUpdate.current) {
                    const saveDataToCloud = async () => {
                        setSyncStatus('Syncing...');
                        try {
                            const db = firebase.firestore();
                            await db.collection("bills").doc("current_data").set(dataToSave);
                            setSyncStatus('Synced ✅');
                            setTimeout(() => setSyncStatus(''), 2000);
                        } catch (e) {
                            setSyncStatus('Sync Failed ❌');
                            addLog("Auto-sync error: " + e.message);
                        }
                    };
                    const timeout = setTimeout(saveDataToCloud, 2000); 
                    return () => clearTimeout(timeout);
                }
            }, [members, houseRate, shopRate, waterBill, motorBill, tankerBill, billMonth]); 

            const initializeFirebase = (config) => {
                if (!window.firebaseApp) {
                    try {
                        if (typeof firebase === 'undefined') { alert("Cloud module loading... Check internet."); return; }
                        if (!firebase.apps.length) window.firebaseApp = firebase.initializeApp(config);
                        else window.firebaseApp = firebase.app();

                        const db = firebase.firestore();
                        setIsCloudActive(true);
                        addLog("Connected to Cloud.");
                        
                        db.collection("bills").doc("current_data").onSnapshot((doc) => { if (doc.exists()) { /* Sync logic */ } });
                        db.collection("bills").doc("history").onSnapshot((doc) => { 
                            if (ignoreRemoteUpdate.current) {
                                addLog("Ignored Cloud update due to local write.");
                                return;
                            }
                            if(doc.exists() && doc.data().records) {
                                setHistory(doc.data().records); 
                                addLog("Received updated history from Cloud.");
                            }
                        });
                    } catch (e) {
                        alert("Error connecting to Cloud. Check keys.");
                        setIsCloudActive(false);
                        addLog("Init Error: " + e.message);
                    }
                } else {
                    setIsCloudActive(true);
                }
            };

            const handleCloudSubmit = () => {
                localStorage.setItem('billSplitterCloudConfig', JSON.stringify(cloudConfig));
                initializeFirebase(cloudConfig);
                setShowCloudSetup(false);
            };

            const handleAddMember = () => setMembers([...members, { id: Date.now(), unit: '', name: '', type: 'family', count: 1 }]);
            const handleRemoveMember = (id) => setMembers(members.filter(m => m.id !== id));
            const handleUpdateMember = (id, field, value) => setMembers(members.map(m => m.id === id ? { ...m, [field]: value } : m));

            const calculate = () => {
                const water = parseFloat(waterBill) || 0;
                const motor = parseFloat(motorBill) || 0;
                const tanker = parseFloat(tankerBill) || 0;
                const totalBill = water + motor + tanker;
                let fixedCollection = 0;
                let totalVariableMembers = 0;
                const hRate = parseFloat(houseRate) || 0;
                const sRate = parseFloat(shopRate) || 0;

                members.forEach(m => {
                    if (m.type === 'house') fixedCollection += hRate;
                    else if (m.type === 'shop') fixedCollection += sRate;
                    else if (m.type !== 'vacant') totalVariableMembers += parseInt(m.count) || 0;
                });

                let finalHRate = hRate, finalSRate = sRate, perPerson = 0, remaining = 0;
                if (totalBill <= fixedCollection) {
                    const scale = fixedCollection > 0 ? totalBill / fixedCollection : 0;
                    finalHRate = hRate * scale; finalSRate = sRate * scale;
                } else {
                    remaining = totalBill - fixedCollection; perPerson = totalVariableMembers > 0 ? remaining / totalVariableMembers : 0;
                }

                const breakdown = members.map(m => {
                    let amount = 0, detail = '';
                    if (m.type === 'house') { amount = finalHRate; detail = 'Fixed House'; }
                    else if (m.type === 'shop') { amount = finalSRate; detail = 'Fixed Shop'; }
                    else if (m.type === 'vacant') { amount = 0; detail = 'Vacant'; }
                    else { 
                        amount = (parseInt(m.count) || 0) * perPerson; 
                        detail = `${m.count} members × ₹${perPerson.toFixed(2)}`; 
                    }
                    return { ...m, amount, detail, paidAmount: 0 }; 
                });
                
                const [year, month] = billMonth.split('-');
                const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
                setResult({ totalBill, perPerson, breakdown, water, motor, tanker, date: new Date().toLocaleString(), billMonthName: monthName, billMonthKey: billMonth });
            };

            const updateCloudHistory = async (newHistory) => {
                // 1. LOCK SYNC
                ignoreRemoteUpdate.current = true;
                addLog("Locking sync for write...");

                // 2. UPDATE LOCAL
                setHistory(newHistory); 

                // 3. UPDATE CLOUD
                if (isCloudActive && window.firebaseApp) {
                    try {
                        const db = firebase.firestore();
                        addLog("Writing to Cloud...");
                        await db.collection("bills").doc("history").set({ records: newHistory });
                        addLog("Cloud Write Success.");
                    } catch (e) { 
                        addLog("Cloud Write Failed: " + e.message);
                        alert("Failed to delete from Cloud! Check internet.");
                    }
                }

                // 4. UNLOCK SYNC (After delay to ensure cloud echoes back)
                setTimeout(() => {
                    ignoreRemoteUpdate.current = false;
                    addLog("Sync Unlocked.");
                }, 2000);
            };

            const saveToHistory = () => { if(!result) return; updateCloudHistory([result, ...history]); alert("Saved to History!"); };
            
            const openPaymentModal = (hIdx, mIdx, item, e) => {
                e.stopPropagation();
                setPaymentModal({ show: true, historyIdx: hIdx, memberIdx: mIdx, currentPaid: item.paidAmount || 0, total: item.amount, name: item.name });
            };

            const savePayment = (amount) => {
                const newPaid = parseFloat(amount) || 0;
                const updatedHistory = [...history];
                updatedHistory[paymentModal.historyIdx].breakdown[paymentModal.memberIdx].paidAmount = newPaid;
                updateCloudHistory(updatedHistory);
                setPaymentModal({ ...paymentModal, show: false });
            };

            const deleteHistory = (i, e) => { 
                e.stopPropagation(); 
                if(confirm("Delete this record permanently?")) {
                    addLog(`Deleting record index ${i}`);
                    const newHistory = history.filter((_, idx) => idx !== i);
                    updateCloudHistory(newHistory);
                }
            };

            const nukeHistory = () => {
                if(confirm("⚠️ DANGER: Clear ALL History?")) {
                    if(confirm("This cannot be undone. Are you sure?")) {
                        addLog("Nuking all history...");
                        updateCloudHistory([]);
                        alert("All history cleared.");
                    }
                }
            };

            const downloadExcel = () => {
                let csv = "Bill Month,Date,Total,Water,Motor,Tanker,Rate,Unit,Name,Amount,Paid,Status\n";
                history.forEach(r => r.breakdown.forEach(b => {
                    const status = b.paidAmount >= b.amount ? 'PAID' : (b.paidAmount > 0 ? 'PARTIAL' : 'PENDING');
                    csv += `${r.billMonthName || r.date},${r.date.replace(',','')},${r.totalBill},${r.water},${r.motor},${r.tanker},${r.perPerson.toFixed(2)},${b.unit||''},${b.name||''},${Math.round(b.amount)},${b.paidAmount},${status}\n`;
                }));
                const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8,"+csv); link.download = "history.csv"; link.click();
            };
            
            const shareFullBill = () => {
                let text = ``;
                if(result.water > 0) text += `Water Bill: ₹${result.water}\n`;
                if(result.motor > 0) text += `Motor Bill: ₹${result.motor}\n`;
                if(result.tanker > 0) text += `Tanker Bill: ₹${result.tanker}\n`;
                text += `\n*Bill - ${result.billMonthName}*\n`;
                text += `Total: ₹${result.totalBill}\n`;
                if(result.perPerson > 0) text += `Rate: ₹${result.perPerson.toFixed(2)}/head\n\n`;
                result.breakdown.forEach(i => {
                    const unitPart = i.unit ? `${i.unit} ` : '';
                    const namePart = i.name || 'Unknown';
                    text += `${unitPart}${namePart}: ₹${Math.round(i.amount)}\n`;
                });
                const t = document.createElement("textarea"); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); alert('Copied!');
            };
            
            const reset = () => { if(confirm("Reset all?")) { setMembers(DEFAULT_MEMBERS); setWaterBill(''); setMotorBill(''); setTankerBill(''); setResult(null); }};

            const getUniqueYears = () => {
                const years = new Set([new Date().getFullYear().toString()]); 
                years.add((new Date().getFullYear() + 1).toString());
                history.forEach(h => {
                    let y = new Date(h.date).getFullYear().toString();
                    if(h.billMonthKey) y = h.billMonthKey.split('-')[0];
                    years.add(y);
                });
                return Array.from(years).sort().reverse(); 
            };

            const calculateStats = () => {
                const stats = { water: 0, motor: 0, tanker: 0, grand: 0, paidTotal: 0, members: {} };
                history.forEach(h => {
                    let recordYear = new Date(h.date).getFullYear().toString();
                    if(h.billMonthKey) recordYear = h.billMonthKey.split('-')[0]; 
                    if (statsYear !== 'All' && recordYear !== statsYear) return; 

                    stats.water += parseFloat(h.water || 0);
                    stats.motor += parseFloat(h.motor || 0);
                    stats.tanker += parseFloat(h.tanker || 0);
                    stats.grand += parseFloat(h.totalBill || 0);
                    
                    h.breakdown.forEach(b => {
                        const key = b.unit ? `${b.unit} ${b.name}` : b.name;
                        if(!stats.members[key]) stats.members[key] = { amount: 0, paid: 0 };
                        stats.members[key].amount += b.amount;
                        stats.members[key].paid += (b.paidAmount || 0);
                        stats.paidTotal += (b.paidAmount || 0);
                    });
                });
                return stats;
            };
            const stats = calculateStats();
            const availableYears = getUniqueYears();

            return (
                <div className="min-h-screen font-sans p-3 md:p-6 max-w-2xl mx-auto text-slate-900 pb-20">
                    <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                        {/* HEADER */}
                        <div className="bg-blue-600 p-6 text-white flex justify-between items-center">
                            <div><h1 className="text-2xl font-bold">Bill Splitter</h1><p className="text-blue-100 opacity-90 text-sm">Cloud Accountant</p></div>
                            <div className="flex gap-2">
                                <button onClick={()=>setShowCloudSetup(true)} className={`p-2 rounded-full transition ${isCloudActive ? 'bg-green-500 hover:bg-green-600' : 'bg-blue-500 hover:bg-blue-400'}`} title="Cloud Setup">{isCloudActive ? <Icons.Cloud /> : <Icons.CloudOff />}</button>
                                <button onClick={reset} className="p-2 bg-blue-500 rounded-full hover:bg-blue-400" title="Reset"><Icons.Reset /></button>
                            </div>
                        </div>

                        {/* CLOUD SETUP MODAL */}
                        {showCloudSetup && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
                                    <h2 className="text-xl font-bold mb-4">☁️ Cloud Setup</h2>
                                    <div className="space-y-3">
                                        <div><label className="text-xs font-bold text-slate-500">API Key</label><input type="text" value={cloudConfig.apiKey} onChange={e=>setCloudConfig({...cloudConfig, apiKey: e.target.value})} className="w-full p-2 border rounded" placeholder="AIzaSy..." /></div>
                                        <div><label className="text-xs font-bold text-slate-500">Project ID</label><input type="text" value={cloudConfig.projectId} onChange={e=>setCloudConfig({...cloudConfig, projectId: e.target.value})} className="w-full p-2 border rounded" placeholder="familybills-123" /></div>
                                    </div>
                                    <div className="mt-6 flex gap-2">
                                        <button onClick={()=>setShowCloudSetup(false)} className="flex-1 py-2 text-slate-500 font-bold">Cancel</button>
                                        <button onClick={handleCloudSubmit} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">Connect</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* PAYMENT MODAL */}
                        {paymentModal.show && (
                            <div className="modal-overlay">
                                <div className="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl animate-in fade-in zoom-in">
                                    <h3 className="text-lg font-bold mb-1">Manage Payment</h3>
                                    <p className="text-sm text-slate-500 mb-4">{paymentModal.name}</p>
                                    <div className="bg-slate-50 p-3 rounded mb-4 text-center">
                                        <div className="text-xs text-slate-400 uppercase">Total Due</div>
                                        <div className="text-2xl font-bold">₹{Math.round(paymentModal.total)}</div>
                                    </div>
                                    <div className="mb-4">
                                        <label className="text-xs font-bold text-slate-500">Paid Amount (₹)</label>
                                        <input type="number" autoFocus value={paymentModal.currentPaid} onChange={(e) => setPaymentModal({...paymentModal, currentPaid: e.target.value})} className="w-full text-xl p-2 border-b-2 border-blue-500 outline-none text-center font-bold" />
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>savePayment(0)} className="flex-1 py-2 bg-red-100 text-red-600 rounded font-bold text-xs">Unpaid</button>
                                        <button onClick={()=>savePayment(paymentModal.total)} className="flex-1 py-2 bg-green-100 text-green-600 rounded font-bold text-xs">Full</button>
                                    </div>
                                    <button onClick={()=>savePayment(paymentModal.currentPaid)} className="w-full mt-3 py-3 bg-blue-600 text-white rounded-lg font-bold">Save Payment</button>
                                </div>
                            </div>
                        )}

                        <div className="flex border-b border-slate-200">
                            <button onClick={()=>setActiveTab('calc')} className={`flex-1 py-3 text-center ${activeTab==='calc'?'tab-active':'tab-inactive'}`}>Calculator</button>
                            <button onClick={()=>setActiveTab('history')} className={`flex-1 py-3 text-center ${activeTab==='history'?'tab-active':'tab-inactive'}`}>History ({history.length})</button>
                        </div>

                        <div className="p-5 space-y-6">
                            {syncStatus && <div className="text-xs text-center text-slate-400 italic">{syncStatus}</div>}
                            
                            {activeTab === 'calc' && (
                                <>
                                    <section className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                        <h2 className="text-md font-bold text-slate-700 mb-3">1. Bill Amounts</h2>
                                        <div className="mb-4">
                                            <label className="block text-xs font-bold text-blue-600 uppercase mb-1">Bill Month</label>
                                            <input type="month" value={billMonth} onChange={(e) => setBillMonth(e.target.value)} className="w-full p-2 border-2 border-blue-100 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500" />
                                        </div>
                                        <div className="grid grid-cols-2 gap-3 mb-3">
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Water</label><input type="number" value={waterBill} onChange={e=>setWaterBill(e.target.value)} className="w-full text-xl p-2 rounded-lg border border-slate-300 outline-none" placeholder="0" /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Motor</label><input type="number" value={motorBill} onChange={e=>setMotorBill(e.target.value)} className="w-full text-xl p-2 rounded-lg border border-slate-300 outline-none" placeholder="0" /></div>
                                        </div>
                                        <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Tanker</label><input type="number" value={tankerBill} onChange={e=>setTankerBill(e.target.value)} className="w-full text-xl p-2 rounded-lg border border-slate-300 outline-none" placeholder="0" /></div>
                                    </section>

                                    <section>
                                        <div className="flex justify-between items-center mb-3">
                                            <h2 className="text-md font-bold text-slate-700">2. Register</h2>
                                            <button onClick={()=>setShowSettings(!showSettings)} className="flex items-center gap-1 text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded border border-blue-200"><Icons.Settings /> {showSettings?'Hide Rates':'Edit Rates'}</button>
                                        </div>
                                        {showSettings && (
                                            <div className="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200 grid grid-cols-2 gap-4">
                                                <div><label className="text-xs font-bold text-yellow-800 block mb-1">House Fixed</label><input type="number" value={houseRate} onChange={e=>setHouseRate(e.target.value)} className="w-full p-1 border rounded" /></div>
                                                <div><label className="text-xs font-bold text-yellow-800 block mb-1">Shop Fixed</label><input type="number" value={shopRate} onChange={e=>setShopRate(e.target.value)} className="w-full p-1 border rounded" /></div>
                                            </div>
                                        )}
                                        <div className="space-y-3">
                                            {members.map(m => (
                                                <div key={m.id} className="flex flex-col gap-2 p-3 bg-white rounded-lg border border-slate-200 shadow-sm">
                                                    <div className="flex gap-2">
                                                        <div className="w-1/3"><input type="text" value={m.unit} onChange={e=>handleUpdateMember(m.id,'unit',e.target.value)} className="w-full font-bold p-1 bg-slate-50 rounded border text-center uppercase" placeholder="Unit" /></div>
                                                        <div className="flex-grow flex gap-2"><input type="text" value={m.name} onChange={e=>handleUpdateMember(m.id,'name',e.target.value)} className="w-full font-semibold p-1 border-b focus:border-blue-500 outline-none" placeholder="Name" /><button onClick={()=>handleRemoveMember(m.id)} className="text-slate-300 hover:text-red-500"><Icons.Trash /></button></div>
                                                    </div>
                                                    <div className="flex items-center gap-3 bg-slate-50 p-2 rounded-md">
                                                        <div className="flex-grow select-wrapper"><select value={m.type} onChange={e=>handleUpdateMember(m.id,'type',e.target.value)} className="w-full bg-transparent text-sm font-medium outline-none appearance-none"><option value="family">Family</option><option value="house">Fixed House</option><option value="shop">Fixed Shop</option><option value="vacant">Vacant</option></select></div>
                                                        {m.type==='family' && <div className="flex items-center gap-1 bg-white rounded px-2 border"><span className="text-[10px] text-slate-400 font-bold">MEMBERS</span><input type="number" value={m.count} onChange={e=>handleUpdateMember(m.id,'count',e.target.value)} className="w-10 text-center font-bold outline-none" /></div>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={handleAddMember} className="mt-4 flex items-center justify-center gap-2 text-blue-600 font-bold text-sm w-full py-2 border border-dashed border-blue-200 rounded-lg hover:bg-blue-50"><Icons.Plus /> Add Unit</button>
                                    </section>

                                    <button onClick={calculate} className="w-full py-3 bg-blue-600 text-white text-lg font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition"><Icons.Calc /> CALCULATE</button>

                                    {result && (
                                        <div className="animate-in fade-in slide-in-from-bottom-4">
                                            <div className="bg-slate-800 text-white p-5 rounded-t-2xl mt-4">
                                                <div className="flex justify-between items-end"><span className="text-slate-400 font-medium text-sm">Total</span><span className="text-3xl font-bold text-green-400">₹{result.totalBill.toLocaleString()}</span></div>
                                                <div className="mt-2 text-xs text-slate-400 flex justify-between">
                                                    <span>Rate: ₹{result.perPerson.toFixed(2)}/head</span>
                                                    <button onClick={saveToHistory} className="flex items-center gap-1 text-white bg-slate-600 px-2 py-1 rounded hover:bg-slate-500"><Icons.Save /> Save to History</button>
                                                </div>
                                            </div>
                                            <div className="bg-white border-x border-b border-slate-200 rounded-b-2xl p-4 shadow-lg">
                                                <div className="divide-y divide-slate-100">
                                                    {result.breakdown.map(item => (
                                                        <div key={item.id} className="py-3 flex justify-between items-center">
                                                            <div>
                                                                <div className="font-bold text-slate-700 text-sm">{item.unit && <span className="bg-slate-100 px-1 rounded mr-2 text-xs border">{item.unit}</span>}{item.name||'Unknown'}</div>
                                                                <div className="text-xs text-slate-400">{item.detail}</div>
                                                            </div>
                                                            <div className="flex items-center gap-3">
                                                                <div className="font-bold text-lg">₹{Math.round(item.amount)}</div>
                                                                {item.amount > 0 && <button onClick={()=>sendIndividualReminder(item, result.date)} className="p-2 bg-green-100 text-green-600 rounded-full hover:bg-green-200" title="Send WhatsApp Reminder"><Icons.Send /></button>}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                                <button onClick={shareFullBill} className="w-full mt-4 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-md"><Icons.Copy /> Copy Full List</button>
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}

                            {/* HISTORY TAB */}
                            {activeTab === 'history' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center mb-4">
                                        <div className="flex bg-slate-100 rounded-lg p-1">
                                            <button onClick={()=>setHistoryView('list')} className={`px-4 py-1.5 rounded-md text-sm font-bold transition ${historyView==='list'?'bg-white shadow text-blue-600':'text-slate-500'}`}><Icons.List /> List</button>
                                            <button onClick={()=>setHistoryView('stats')} className={`px-4 py-1.5 rounded-md text-sm font-bold transition ${historyView==='stats'?'bg-white shadow text-blue-600':'text-slate-500'}`}><Icons.Chart /> Stats</button>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={nukeHistory} className="p-2 bg-red-100 text-red-600 rounded-full hover:bg-red-200" title="Clear All History"><Icons.Nuke /></button>
                                            <button onClick={downloadExcel} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200" title="Download Excel"><Icons.Download /></button>
                                        </div>
                                    </div>

                                    {/* DEBUG CONSOLE (Only shows if logs exist) */}
                                    {logs.length > 0 && (
                                        <div className="debug-console mb-4">
                                            {logs.map((l, i) => <div key={i}>{l}</div>)}
                                        </div>
                                    )}

                                    {history.length === 0 ? <p className="text-center text-slate-400 py-10">No history saved yet.</p> : (
                                        <>
                                            {/* STATS VIEW */}
                                            {historyView === 'stats' && (
                                                <div className="animate-in fade-in space-y-4">
                                                    <div className="flex justify-between items-center mb-2">
                                                       <h3 className="text-sm font-bold text-slate-400 uppercase">{statsYear === 'All' ? 'All Time' : `${statsYear} Expenses`}</h3>
                                                       <select value={statsYear} onChange={(e) => setStatsYear(e.target.value)} className="bg-white border rounded p-1 text-xs font-bold">
                                                          {availableYears.map(y => <option key={y} value={y}>{y}</option>)}
                                                          <option value="All">All Time</option>
                                                       </select>
                                                    </div>
                                                    <div className="bg-slate-800 text-white p-4 rounded-xl shadow-lg">
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <div><div className="text-xs text-slate-400">Total Billed</div><div className="text-xl font-bold">₹{stats.grand.toLocaleString()}</div></div>
                                                            <div><div className="text-xs text-slate-400">Total Collected</div><div className="text-xl font-bold text-green-400">₹{stats.paidTotal.toLocaleString()}</div></div>
                                                            <div className="col-span-2 pt-2 border-t border-slate-700 flex justify-between">
                                                                <span className="text-xs text-red-400">Total Pending:</span>
                                                                <span className="text-sm font-bold text-red-400">₹{(stats.grand - stats.paidTotal).toLocaleString()}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="bg-white border rounded-xl p-4 shadow-sm">
                                                        <h3 className="text-sm font-bold text-slate-600 mb-3 uppercase">Member Shares</h3>
                                                        <div className="divide-y divide-slate-100">
                                                            {Object.entries(stats.members).map(([name, data]) => {
                                                                const pending = data.amount - data.paid;
                                                                return (
                                                                    <div key={name} className="py-3 flex justify-between items-center">
                                                                        <span className="font-bold text-slate-700 text-sm w-1/3">{name}</span>
                                                                        <div className="flex flex-col items-end">
                                                                            <span className="text-xs text-slate-400">Billed: ₹{Math.round(data.amount).toLocaleString()}</span>
                                                                            <span className="font-bold text-sm text-green-600">Paid: ₹{Math.round(data.paid).toLocaleString()}</span>
                                                                            {pending > 0 && <span className="text-[10px] font-bold text-red-500">Due: ₹{Math.round(pending).toLocaleString()}</span>}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* LIST VIEW */}
                                            {historyView === 'list' && history.map((h, idx) => {
                                                const totalPaidForRecord = h.breakdown.reduce((sum, item) => sum + (item.paidAmount || 0), 0);
                                                const totalDueForRecord = h.totalBill - totalPaidForRecord;
                                                return (
                                                <div key={idx} className={`bg-white border rounded-xl p-4 shadow-sm relative cursor-pointer history-card ${expandedHistory === idx ? 'history-expanded' : 'border-slate-200'}`} onClick={() => setExpandedHistory(expandedHistory === idx ? null : idx)}>
                                                    <button onClick={(e)=>deleteHistory(idx, e)} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 z-10 p-2"><Icons.Trash /></button>
                                                    <div className="pr-8">
                                                        <div className="font-bold text-slate-700 mb-1 flex items-center gap-2">{h.billMonthName || h.date} {expandedHistory === idx ? <Icons.ChevronUp /> : <Icons.ChevronDown />}</div>
                                                        <div className="flex justify-between text-sm mb-1"><span className="text-slate-500">Total Bill:</span><span className="font-bold">₹{h.totalBill}</span></div>
                                                        <div className="flex justify-between text-xs">
                                                            <span className={totalDueForRecord > 0 ? "text-red-400 font-semibold" : "text-green-500 font-semibold"}>{totalDueForRecord > 0 ? "Pending:" : "Status:"}</span>
                                                            <span className={totalDueForRecord > 0 ? "font-bold text-red-500" : "font-bold text-green-500"}>{totalDueForRecord > 0 ? `₹${totalDueForRecord}` : "Paid ✅"}</span>
                                                        </div>
                                                    </div>
                                                    {expandedHistory === idx && (
                                                        <div className="mt-4 pt-4 border-t border-slate-300 animate-in fade-in slide-in-from-top-1">
                                                            <div className="text-xs text-slate-500 mb-3 bg-white p-2 rounded border">Water: {h.water} | Motor: {h.motor} | Tanker: {h.tanker}</div>
                                                            <div className="divide-y divide-slate-200">{h.breakdown.map((item, i) => (
                                                                <div key={i} className="py-2 flex justify-between items-center">
                                                                    <div><div className="font-bold text-sm text-slate-700">{item.unit} {item.name}</div></div>
                                                                    <div className="flex items-center gap-3">
                                                                        <div className="text-right">
                                                                            <div className="font-bold text-sm">₹{Math.round(item.amount)}</div>
                                                                            {item.paidAmount > 0 && <div className={`text-[10px] font-bold ${item.paidAmount >= item.amount ? 'text-green-600' : 'text-orange-500'}`}>{item.paidAmount >= item.amount ? 'Paid' : `Due: ₹${Math.round(item.amount - item.paidAmount)}`}</div>}
                                                                        </div>
                                                                        {item.amount > 0 && (
                                                                            <>
                                                                                <button onClick={(e) => openPaymentModal(idx, i, item, e)} className={`w-8 h-8 rounded-full flex items-center justify-center border status-btn ${item.paidAmount >= item.amount ? 'bg-green-100 border-green-500 text-green-700' : (item.paidAmount > 0 ? 'bg-orange-100 border-orange-400 text-orange-600' : 'bg-white border-red-200 text-red-300')}`}><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg></button>
                                                                                <button onClick={(e) => {e.stopPropagation(); sendIndividualReminder(item, h.billMonthName);}} className="p-2 bg-slate-100 text-slate-600 rounded-full hover:bg-slate-200"><Icons.Send /></button>
                                                                            </>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}</div>
                                                        </div>
                                                    )}
                                                </div>
                                            )})}
                                        </>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="text-center mt-8 opacity-60"><p className="text-sm font-medium text-slate-500">Developed by Babu Mani (@ChartWizMani)</p></div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
